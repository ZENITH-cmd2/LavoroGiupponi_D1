<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calor Systems â€” Dashboard Riconciliazione</title>
    <meta name="description" content="Sistema di riconciliazione automatica incassi per stazioni di servizio">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@600;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <!-- â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â• -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <span class="logo-icon">â›½</span>
                <div>
                    <h1>Calor Systems</h1>
                    <span class="logo-sub">Riconciliazione</span>
                </div>
            </div>
        </div>
        <ul class="nav-list">
            <li class="nav-item active" data-view="dashboard">
                <span class="nav-icon">ğŸ“Š</span>
                <span>Dashboard</span>
            </li>
            <li class="nav-item" data-view="upload">
                <span class="nav-icon">ğŸ“‚</span>
                <span>Carica File</span>
            </li>
            <li class="nav-item" data-view="riconciliazioni">
                <span class="nav-icon">ğŸ”„</span>
                <span>Riconciliazioni</span>
            </li>
            <li class="nav-item" data-view="contanti">
                <span class="nav-icon">ğŸ’°</span>
                <span>Contanti</span>
            </li>
            <li class="nav-item" data-view="impianti">
                <span class="nav-icon">ğŸ¢</span>
                <span>Impianti</span>
            </li>
            <li class="nav-item" data-view="sicurezza">
                <span class="nav-icon">ğŸ”</span>
                <span>Sicurezza</span>
            </li>
            <li class="nav-item" data-view="ai-report">
                <span class="nav-icon">ğŸ¤–</span>
                <span>Report AI</span>
            </li>
        </ul>
        <div class="sidebar-footer">
            <div class="sidebar-version">v2.0 â€” Workflow Completo</div>
        </div>
    </nav>

    <!-- â•â•â•â•â•â•â•â•â•â• MAIN CONTENT â•â•â•â•â•â•â•â•â•â• -->
    <main class="main-content">
        <!-- HEADER BAR -->
        <header class="top-bar">
            <button class="menu-toggle" id="menuToggle">â˜°</button>
            <h2 class="page-title" id="pageTitle">Dashboard</h2>
            <div class="header-right">
                <span class="status-dot" id="statusDot"></span>
                <span class="status-text" id="statusText">Connesso</span>
                <button id="btnLogout" class="btn-small" style="margin-left: 16px;">Esci</button>
            </div>
        </header>

        <!-- â•â•â• VIEW: DASHBOARD â•â•â• -->
        <section class="view active" id="view-dashboard">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card" id="statImpianti">
                    <div class="stat-icon">ğŸ¢</div>
                    <div class="stat-value">â€”</div>
                    <div class="stat-label">Impianti Attivi</div>
                </div>
                <div class="stat-card" id="statGiornate">
                    <div class="stat-icon">ğŸ“…</div>
                    <div class="stat-value">â€”</div>
                    <div class="stat-label">Giornate Analizzate</div>
                </div>
                <div class="stat-card stat-ok" id="statQuadrate">
                    <div class="stat-icon">âœ…</div>
                    <div class="stat-value">â€”</div>
                    <div class="stat-label">Quadrature OK</div>
                </div>
                <div class="stat-card stat-warn" id="statAnomalie">
                    <div class="stat-icon">âš ï¸</div>
                    <div class="stat-value">â€”</div>
                    <div class="stat-label">Anomalie Aperte</div>
                </div>
                <div class="stat-card stat-danger" id="statGravi">
                    <div class="stat-icon">ğŸ”´</div>
                    <div class="stat-value">â€”</div>
                    <div class="stat-label">Anomalie Gravi</div>
                </div>
                <div class="stat-card" id="statRecords">
                    <div class="stat-icon">ğŸ“„</div>
                    <div class="stat-value">â€”</div>
                    <div class="stat-label">Record Importati</div>
                </div>
            </div>

            <!-- Stato Verifiche per Impianto -->
            <div class="section-header">
                <h3>Stato Verifiche per Impianto</h3>
                <button class="btn-refresh" onclick="loadStatoVerifiche()">ğŸ”„ Aggiorna</button>
            </div>
            <div class="verifiche-grid" id="verificheGrid">
                <div class="empty-state">Nessun dato disponibile. Carica i file Excel per iniziare.</div>
            </div>
        </section>

        <!-- â•â•â• VIEW: UPLOAD â•â•â• -->
        <section class="view" id="view-upload">
            <div class="upload-container">
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">ğŸ“‚</div>
                    <h3>Trascina qui i file Excel</h3>
                    <p>Oppure clicca per selezionare i file</p>
                    <p class="upload-hint">Supportati: Fortech, AS400, Numia, iP Portal, Satispay</p>
                    <input type="file" id="fileInput" multiple accept=".xlsx,.xls,.csv" hidden>
                </div>

                <div class="file-list" id="fileList">
                    <!-- Files will be listed here -->
                </div>

                <div class="upload-actions" id="uploadActions" style="display:none">
                    <button class="btn btn-secondary" onclick="clearFiles()">ğŸ—‘ Svuota</button>
                    <button class="btn btn-primary" id="btnProcess" onclick="processFiles()">â–¶ Elabora File</button>
                </div>

                <!-- Processing Progress -->
                <div class="progress-section" id="progressSection" style="display:none">
                    <div class="progress-header">
                        <span class="progress-phase" id="progressPhase">Preparazione...</span>
                        <span class="progress-pct" id="progressPct">0%</span>
                    </div>
                    <div class="progress-bar-track">
                        <div class="progress-bar-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-log" id="progressLog"></div>
                </div>

                <!-- Results Summary -->
                <div class="results-summary" id="resultsSummary" style="display:none">
                    <div class="results-header">
                        <span class="results-icon">âœ…</span>
                        <h3>Elaborazione Completata</h3>
                    </div>
                    <div class="results-stats" id="resultsStats"></div>
                    <button class="btn btn-primary" onclick="switchView('riconciliazioni')">ğŸ“Š Vedi Risultati</button>
                </div>
            </div>
        </section>

        <!-- â•â•â• VIEW: RICONCILIAZIONI â•â•â• -->
        <section class="view" id="view-riconciliazioni">
            <div class="section-header">
                <h3>Risultati Riconciliazione</h3>
                <div class="filters">
                    <input type="date" id="filterDa" class="input-date" placeholder="Da">
                    <input type="date" id="filterA" class="input-date" placeholder="A">
                    <button class="btn btn-small" onclick="loadRiconciliazioni()">Filtra</button>
                </div>
            </div>
            <div id="riconciliazioniTablesContainer">
                <div class="table-container">
                    <table class="data-table" id="riconciliazioniTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Impianto</th>
                                <th>Categoria</th>
                                <th>Fortech (â‚¬)</th>
                                <th>Reale (â‚¬)</th>
                                <th>Diff (â‚¬)</th>
                                <th>Stato</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody id="riconciliazioniBody">
                            <tr>
                                <td colspan="8" class="empty-state">Nessun dato</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- â•â•â• VIEW: CONTANTI (SIMONA - CONFERMA MATCHING) â•â•â• -->
        <section class="view" id="view-contanti">
            <div class="section-header">
                <h3>ğŸ’° Controllo Contanti â€” Conferma Matching</h3>
                <button class="btn-refresh" onclick="loadContantiBanca()">ğŸ”„ Aggiorna</button>
            </div>
            <p class="view-description">Verifica i risultati del matching automatico tra contante teorico (Fortech) e
                versamenti bancari (AS400). Espandi ogni riga per vedere i dettagli del calcolo e conferma o segnala il
                risultato.</p>

            <!-- Summary Stats -->
            <div class="contanti-stats" id="contantiStats"></div>

            <!-- Matching Results -->
            <div class="contanti-list" id="contantiList">
                <div class="empty-state">Nessun dato contanti disponibile</div>
            </div>
        </section>

        <!-- â•â•â• VIEW: IMPIANTI â•â•â• -->
        <section class="view" id="view-impianti">
            <div class="section-header">
                <h3>ğŸ¢ Impianti</h3>
                <button class="btn-refresh" onclick="loadImpianti()">ğŸ”„ Aggiorna</button>
            </div>
            <div class="impianti-grid" id="impiantiGrid">
                <div class="empty-state">Nessun dato</div>
            </div>
        </section>

        <!-- â•â•â• VIEW: SICUREZZA â•â•â• -->
        <section class="view" id="view-sicurezza">
            <div class="section-header">
                <h3>ğŸ” Alert Sicurezza â€” Taleggio</h3>
            </div>
            <p class="view-description">Monitoraggio aperture cassaforte per impianti self-service (Taleggio).
                L'apertura Ã¨ autorizzata solo il giovedÃ¬. Il contante prelevato deve corrispondere all'incasso Fortech
                nel periodo.</p>

            <div
                style="background:var(--bg-card);border-radius:var(--radius);border:1px solid rgba(210,153,34,0.3);padding:48px 32px;text-align:center;max-width:600px;margin:40px auto">
                <div style="font-size:48px;margin-bottom:16px">ğŸš§</div>
                <h3 style="font-size:18px;font-weight:700;margin-bottom:12px">FunzionalitÃ  in arrivo</h3>
                <p style="color:var(--text-secondary);font-size:13px;line-height:1.7;margin-bottom:20px">
                    Questa sezione sarÃ  attiva nella prossima versione, quando verrÃ  integrato il modulo di
                    <strong>scraping Taleggio</strong> per la lettura automatica degli eventi cassaforte IoT.
                </p>
                <div style="display:flex;flex-direction:column;gap:8px;text-align:left;max-width:380px;margin:0 auto">
                    <div style="display:flex;align-items:center;gap:10px;font-size:12px;color:var(--text-secondary)">
                        <span style="color:var(--status-ok)">âœ…</span> Struttura frontend pronta
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;font-size:12px;color:var(--text-secondary)">
                        <span style="color:var(--status-ok)">âœ…</span> Endpoint API <code
                            style="background:var(--bg-tertiary);padding:1px 6px;border-radius:4px;font-size:11px">/api/sicurezza</code>
                        configurato
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;font-size:12px;color:var(--text-secondary)">
                        <span style="color:var(--status-warn)">â³</span> In attesa: modulo scraping Taleggio
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;font-size:12px;color:var(--text-secondary)">
                        <span style="color:var(--status-warn)">â³</span> In attesa: integrazione dati cassaforte IoT
                    </div>
                </div>
            </div>
        </section>

        <!-- â•â•â• VIEW: AI REPORT â•â•â• -->
        <section class="view" id="view-ai-report">
            <div class="section-header">
                <h3>ğŸ¤– Report AI â€” Analisi Intelligente</h3>
            </div>
            <p class="view-description">L'intelligenza artificiale analizza i risultati della riconciliazione e genera
                un report professionale con anomalie, criticitÃ  e suggerimenti. Powered by OpenRouter (GPT-4o Mini).</p>

            <div class="ai-controls">
                <button class="btn btn-ai" id="btnGenerateAI" onclick="generateAIReport()">
                    <span class="ai-sparkle">âœ¨</span> Genera Report AI
                </button>
                <span class="ai-status" id="aiStatus"></span>
            </div>

            <div class="ai-report-container" id="aiReportContainer" style="display:none">
                <div class="ai-report-header">
                    <span>ğŸ¤– Analisi AI</span>
                    <span class="ai-timestamp" id="aiTimestamp"></span>
                </div>
                <div class="ai-report-body" id="aiReportBody"></div>
            </div>
        </section>
    </main>

    <!-- â•â•â•â•â•â•â•â•â•â• MODAL: DETTAGLIO IMPIANTO â•â•â•â•â•â•â•â•â•â• -->
    <div class="modal-overlay" id="modalOverlay" style="display:none" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div>
                    <h3 id="modalTitle">Impianto</h3>
                    <span class="modal-subtitle" id="modalSubtitle"></span>
                </div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="empty-state">Caricamento...</div>
            </div>
        </div>
    </div>

    <script src="/static/_auth.js"></script>
    <script src="/static/app.js"></script>
</body>

</html>